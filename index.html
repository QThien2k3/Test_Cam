<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Live Stream</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
            background: linear-gradient(45deg, #fff, #ffd700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px 25px;
            border-radius: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ff4757;
            animation: pulse 2s infinite;
        }

        .status-indicator.online {
            background: #2ed573;
        }

        .camera-container {
            position: relative;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            min-height: 400px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .camera-stream {
            width: 100%;
            height: auto;
            max-height: 600px;
            object-fit: contain;
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .no-signal {
            text-align: center;
            padding: 50px;
            opacity: 0.7;
        }

        .controls {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            background: linear-gradient(45deg, #ff6b6b, #ee5a24);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn.success {
            background: linear-gradient(45deg, #2ed573, #1e90ff);
        }

        .btn.info {
            background: linear-gradient(45deg, #3742fa, #2f3542);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .info-card {
            background: rgba(0, 0, 0, 0.2);
            padding: 20px;
            border-radius: 15px;
            border-left: 4px solid #ffd700;
        }

        .info-card h3 {
            margin: 0 0 10px 0;
            color: #ffd700;
        }

        .info-value {
            font-family: 'Courier New', monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 8px;
            word-break: break-all;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .status-bar {
                flex-direction: column;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ESP32-CAM Live Stream</h1>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator" id="cameraStatus"></div>
                <span id="statusText">ƒêang k·∫øt n·ªëi...</span>
            </div>
            <div class="status-item">
                <span>IP: </span>
                <span id="cameraIP">ƒêang t√¨m ki·∫øm...</span>
            </div>
            <div class="status-item">
                <span>Uptime: </span>
                <span id="uptime">00:00:00</span>
            </div>
        </div>

        <div class="camera-container">
            <img id="cameraStream" class="camera-stream" alt="Camera Stream">
            <div id="loadingSpinner" class="loading-spinner"></div>
            <div id="noSignal" class="no-signal" style="display: none;">
                <h3>üì∑ Kh√¥ng c√≥ t√≠n hi·ªáu</h3>
                <p>ƒêang ch·ªù k·∫øt n·ªëi camera...</p>
            </div>
        </div>

        <div class="controls">
            <button class="btn success" onclick="startStream()">üé• B·∫Øt ƒë·∫ßu Stream</button>
            <button class="btn info" onclick="refreshConnection()">üîÑ L√†m m·ªõi</button>
            <button class="btn" onclick="capturePhoto()">üì∏ Ch·ª•p ·∫£nh</button>
            <button class="btn info" onclick="autoDetectIP()">üîç T·ª± ƒë·ªông t√¨m IP</button>
        </div>

        <div class="info-grid">
            <div class="info-card">
                <h3>üì° ƒê·ªãa ch·ªâ IP</h3>
                <div class="info-value" id="displayIP">Ch∆∞a x√°c ƒë·ªãnh</div>
            </div>
            <div class="info-card">
                <h3>üîó Stream URL</h3>
                <div class="info-value" id="displayStreamURL">Ch∆∞a c√≥</div>
            </div>
            <div class="info-card">
                <h3>üåê mDNS</h3>
                <div class="info-value" id="displayMDNS">esp32cam.local</div>
            </div>
            <div class="info-card">
                <h3>‚ÑπÔ∏è Tr·∫°ng th√°i</h3>
                <div class="info-value" id="displayStatus">ƒêang kh·ªüi t·∫°o</div>
            </div>
        </div>
    </div>

    <!-- E-Ra Widget Integration -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <script>
        // Global variables
        let eraWidget = null;
        let currentCameraIP = null;
        let streamURL = null;
        let cameraStatus = false;
        let startTime = Date.now();
        let configCameraIP = null;
        let configCameraStatus = null;
        let configStreamURL = null;
        let configCameraInfo = null;

        // Initialize E-Ra Widget
        function initializeEraWidget() {
            try {
                eraWidget = new EraWidget();
                
                eraWidget.init({
                    onConfiguration: (configuration) => {
                        console.log('E-Ra Configuration received:', configuration);
                        
                        // Map configurations theo Virtual Pin
                        if (configuration.realtime_configs) {
                            configCameraIP = configuration.realtime_configs.find(c => c.pin === 'V0');
                            configCameraStatus = configuration.realtime_configs.find(c => c.pin === 'V1');
                            configStreamURL = configuration.realtime_configs.find(c => c.pin === 'V2');
                            configCameraInfo = configuration.realtime_configs.find(c => c.pin === 'V3');
                        }
                        
                        console.log('Configurations mapped successfully');
                    },

                    onValues: (values) => {
                        console.log('E-Ra Values received:', values);
                        
                        try {
                            // C·∫≠p nh·∫≠t IP camera t·ª´ V0
                            if (configCameraIP && values[configCameraIP.id]) {
                                const newIP = values[configCameraIP.id].value;
                                if (newIP && newIP !== currentCameraIP) {
                                    currentCameraIP = newIP;
                                    updateCameraIP(newIP);
                                }
                            }
                            
                            // C·∫≠p nh·∫≠t tr·∫°ng th√°i camera t·ª´ V1
                            if (configCameraStatus && values[configCameraStatus.id]) {
                                const status = values[configCameraStatus.id].value;
                                updateCameraStatus(status === 1);
                            }
                            
                            // C·∫≠p nh·∫≠t Stream URL t·ª´ V2
                            if (configStreamURL && values[configStreamURL.id]) {
                                const newStreamURL = values[configStreamURL.id].value;
                                if (newStreamURL && newStreamURL !== streamURL) {
                                    streamURL = newStreamURL;
                                    updateStreamURL(newStreamURL);
                                }
                            }
                            
                            // C·∫≠p nh·∫≠t th√¥ng tin camera t·ª´ V3
                            if (configCameraInfo && values[configCameraInfo.id]) {
                                const cameraInfo = values[configCameraInfo.id].value;
                                if (cameraInfo) {
                                    try {
                                        const info = JSON.parse(cameraInfo);
                                        updateCameraInfo(info);
                                    } catch (e) {
                                        console.log('Camera info is not JSON:', cameraInfo);
                                    }
                                }
                            }
                        } catch (error) {
                            console.error('Error processing E-Ra values:', error);
                        }
                    }
                });
                
                console.log('E-Ra Widget initialized successfully');
            } catch (error) {
                console.error('Failed to initialize E-Ra Widget:', error);
                // Fallback to manual IP detection
                setTimeout(autoDetectIP, 2000);
            }
        }

        // Update camera IP
        function updateCameraIP(ip) {
            console.log('Updating camera IP:', ip);
            document.getElementById('cameraIP').textContent = ip;
            document.getElementById('displayIP').textContent = ip;
            
            // Update stream URL
            streamURL = `http://${ip}/stream`;
            updateStreamURL(streamURL);
        }

        // Update stream URL
        function updateStreamURL(url) {
            console.log('Updating stream URL:', url);
            streamURL = url;
            document.getElementById('displayStreamURL').textContent = url;
            
            // Auto start stream if camera is online
            if (cameraStatus && url) {
                setTimeout(startStream, 1000);
            }
        }

        // Update camera status
        function updateCameraStatus(isOnline) {
            console.log('Updating camera status:', isOnline);
            cameraStatus = isOnline;
            
            const statusIndicator = document.getElementById('cameraStatus');
            const statusText = document.getElementById('statusText');
            const displayStatus = document.getElementById('displayStatus');
            
            if (isOnline) {
                statusIndicator.classList.add('online');
                statusText.textContent = 'Camera Online';
                displayStatus.textContent = 'Tr·ª±c tuy·∫øn';
                
                // Auto start stream
                if (streamURL) {
                    setTimeout(startStream, 500);
                }
            } else {
                statusIndicator.classList.remove('online');
                statusText.textContent = 'Camera Offline';
                displayStatus.textContent = 'Ngo·∫°i tuy·∫øn';
                
                showNoSignal();
            }
        }

        // Update camera info
        function updateCameraInfo(info) {
            console.log('Updating camera info:', info);
            
            if (info.ip) updateCameraIP(info.ip);
            if (info.stream_url) updateStreamURL(info.stream_url);
            if (info.mdns) {
                document.getElementById('displayMDNS').textContent = info.mdns;
            }
            if (info.status) {
                updateCameraStatus(info.status === 'online');
            }
        }

        // Start video stream v·ªõi CORS v√† Mixed Content handling
        function startStream() {
            console.log('Starting stream with URL:', streamURL);
            
            if (!streamURL) {
                console.log('No stream URL, trying auto detection...');
                autoDetectIP();
                return;
            }
            
            const streamImg = document.getElementById('cameraStream');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const noSignal = document.getElementById('noSignal');
            
            // Show loading
            loadingSpinner.style.display = 'block';
            streamImg.style.display = 'none';
            noSignal.style.display = 'none';
            
            // Try different approaches for iframe compatibility
            tryStreamMethods();
        }
        
        // Try multiple methods to display stream
        function tryStreamMethods() {
            const methods = [
                () => tryDirectImage(),
                () => tryIframeEmbed(),
                () => tryProxyMethod(),
                () => tryBase64Method()
            ];
            
            let currentMethod = 0;
            
            function tryNextMethod() {
                if (currentMethod < methods.length) {
                    console.log(`Trying stream method ${currentMethod + 1}/${methods.length}`);
                    methods[currentMethod]();
                    currentMethod++;
                } else {
                    console.log('All stream methods failed');
                    showNoSignal();
                }
            }
            
            // Start with first method
            tryNextMethod();
            
            // Auto retry next method if current fails
            window.streamRetryMethod = tryNextMethod;
        }
        
        // Method 1: Direct image (most common issue with CORS)
        function tryDirectImage() {
            console.log('Method 1: Direct image');
            const streamImg = document.getElementById('cameraStream');
            
            streamImg.onload = function() {
                console.log('Direct image method successful');
                document.getElementById('loadingSpinner').style.display = 'none';
                streamImg.style.display = 'block';
            };
            
            streamImg.onerror = function() {
                console.log('Direct image method failed');
                setTimeout(window.streamRetryMethod, 2000);
            };
            
            // Remove crossorigin attribute that might cause CORS issues
            streamImg.removeAttribute('crossorigin');
            streamImg.src = streamURL + '?t=' + new Date().getTime();
        }
        
        // Method 2: Iframe embed (bypass CORS completely)
        function tryIframeEmbed() {
            console.log('Method 2: Iframe embed');
            const cameraContainer = document.querySelector('.camera-container');
            
            // Remove existing content
            cameraContainer.innerHTML = '';
            
            // Create iframe
            const iframe = document.createElement('iframe');
            iframe.src = streamURL.replace('/stream', '/');  // Use main page instead of direct stream
            iframe.style.width = '100%';
            iframe.style.height = '500px';
            iframe.style.border = 'none';
            iframe.style.borderRadius = '15px';
            iframe.frameBorder = '0';
            iframe.allowFullscreen = true;
            
            iframe.onload = function() {
                console.log('Iframe embed method successful');
                document.getElementById('loadingSpinner').style.display = 'none';
            };
            
            iframe.onerror = function() {
                console.log('Iframe embed method failed');
                setTimeout(window.streamRetryMethod, 2000);
            };
            
            cameraContainer.appendChild(iframe);
        }
        
        // Method 3: Proxy method using data URLs
        function tryProxyMethod() {
            console.log('Method 3: Proxy method');
            
            // Create a simple proxy using fetch API
            async function fetchStream() {
                try {
                    const response = await fetch(streamURL.replace('/stream', '/capture'), {
                        mode: 'no-cors',
                        cache: 'no-cache'
                    });
                    
                    if (response.ok) {
                        const blob = await response.blob();
                        const objectURL = URL.createObjectURL(blob);
                        
                        const streamImg = document.getElementById('cameraStream');
                        streamImg.src = objectURL;
                        streamImg.onload = function() {
                            console.log('Proxy method successful');
                            document.getElementById('loadingSpinner').style.display = 'none';
                            streamImg.style.display = 'block';
                            
                            // Refresh image every 2 seconds for pseudo-stream
                            setTimeout(fetchStream, 2000);
                        };
                    } else {
                        throw new Error('Fetch failed');
                    }
                } catch (error) {
                    console.log('Proxy method failed:', error);
                    setTimeout(window.streamRetryMethod, 2000);
                }
            }
            
            fetchStream();
        }
        
        // Method 4: Base64 encoded approach
        function tryBase64Method() {
            console.log('Method 4: Fallback message');
            
            const cameraContainer = document.querySelector('.camera-container');
            cameraContainer.innerHTML = `
                <div style="padding: 40px; text-align: center; background: rgba(255,255,255,0.1); border-radius: 15px;">
                    <h3>üìπ Camera Stream Available</h3>
                    <p>Camera is online at: <strong>${currentCameraIP}</strong></p>
                    <p>Click button below to open stream in new window:</p>
                    <button onclick="window.open('${streamURL.replace('/stream', '/')}', '_blank')" 
                            style="padding: 15px 30px; background: #28a745; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; margin: 10px;">
                        üöÄ Open Camera Stream
                    </button>
                    <br>
                    <button onclick="window.open('${streamURL}', '_blank')" 
                            style="padding: 15px 30px; background: #007bff; color: white; border: none; border-radius: 25px; font-size: 16px; cursor: pointer; margin: 10px;">
                        üì∫ Direct Stream
                    </button>
                    <br>
                    <small style="opacity: 0.8;">
                        Due to browser security policies, the stream may not display directly in iframe.<br>
                        Use the buttons above to access the camera stream.
                    </small>
                </div>
            `;
            
            document.getElementById('loadingSpinner').style.display = 'none';
        }

        // Show no signal message
        function showNoSignal() {
            document.getElementById('loadingSpinner').style.display = 'none';
            document.getElementById('cameraStream').style.display = 'none';
            document.getElementById('noSignal').style.display = 'block';
        }

        // Try mDNS connection as fallback
        function tryMDNSConnection() {
            console.log('Trying mDNS connection...');
            const mdnsURL = 'http://esp32cam.local/stream';
            
            const testImg = new Image();
            testImg.onload = function() {
                console.log('mDNS connection successful');
                streamURL = mdnsURL;
                updateStreamURL(mdnsURL);
                startStream();
            };
            testImg.onerror = function() {
                console.log('mDNS connection failed');
            };
            testImg.src = mdnsURL + '?test=' + new Date().getTime();
        }

        // Auto detect IP by scanning common ranges
        function autoDetectIP() {
            console.log('Auto detecting camera IP...');
            document.getElementById('statusText').textContent = 'ƒêang qu√©t m·∫°ng...';
            
            // Get current network info
            const currentIP = getCurrentNetworkIP();
            if (currentIP) {
                scanIPRange(currentIP);
            } else {
                // Fallback to common ranges
                scanCommonRanges();
            }
        }

        // Get current network IP (approximation)
        function getCurrentNetworkIP() {
            // This is a simplified approach
            // In real scenario, we might need WebRTC or other methods
            return null; // Will use common ranges
        }

        // Scan common IP ranges
        function scanCommonRanges() {
            const commonRanges = [
                '192.168.1.',
                '192.168.0.',
                '192.168.4.',
                '10.0.0.',
                '172.16.0.'
            ];
            
            let scanCount = 0;
            const totalScans = commonRanges.length * 254;
            
            commonRanges.forEach(range => {
                for (let i = 1; i <= 254; i++) {
                    const testIP = range + i;
                    testCameraIP(testIP, () => {
                        scanCount++;
                        if (scanCount >= totalScans) {
                            document.getElementById('statusText').textContent = 'Qu√©t ho√†n t·∫•t';
                        }
                    });
                }
            });
        }

        // Scan specific IP range
        function scanIPRange(baseIP) {
            const parts = baseIP.split('.');
            const subnet = parts.slice(0, 3).join('.') + '.';
            
            for (let i = 1; i <= 254; i++) {
                const testIP = subnet + i;
                testCameraIP(testIP);
            }
        }

        // Test if IP has camera
        function testCameraIP(ip, callback) {
            const testURL = `http://${ip}/stream`;
            const timeout = 2000; // 2 seconds timeout
            
            const img = new Image();
            const timer = setTimeout(() => {
                img.onload = img.onerror = null;
                if (callback) callback();
            }, timeout);
            
            img.onload = function() {
                clearTimeout(timer);
                console.log('Found camera at:', ip);
                
                // Update IP and stream
                currentCameraIP = ip;
                updateCameraIP(ip);
                updateCameraStatus(true);
                
                // Notify E-Ra if available
                if (eraWidget && configCameraIP) {
                    try {
                        // Send discovered IP back to E-Ra
                        eraWidget.triggerAction({
                            pin: 'V0',
                            value: ip
                        }, null);
                    } catch (e) {
                        console.log('Could not send IP to E-Ra:', e);
                    }
                }
                
                if (callback) callback();
            };
            
            img.onerror = function() {
                clearTimeout(timer);
                if (callback) callback();
            };
            
            img.src = testURL + '?test=' + new Date().getTime();
        }

        // Refresh connection
        function refreshConnection() {
            console.log('Refreshing connection...');
            
            // Reset status
            updateCameraStatus(false);
            
            // Request fresh data from E-Ra
            if (eraWidget && configCameraIP) {
                try {
                    eraWidget.triggerAction({
                        pin: 'V0',
                        value: 'get_ip'
                    }, null);
                } catch (e) {
                    console.log('Could not request IP from E-Ra:', e);
                }
            }
            
            // Fallback to auto detection
            setTimeout(autoDetectIP, 1000);
        }

        // Capture photo
        function capturePhoto() {
            if (!currentCameraIP) {
                alert('Ch∆∞a c√≥ k·∫øt n·ªëi camera');
                return;
            }
            
            const captureURL = `http://${currentCameraIP}/capture`;
            
            // Open in new window
            const newWindow = window.open(captureURL, '_blank', 'width=800,height=600');
            
            if (!newWindow) {
                // Fallback - create download link
                const link = document.createElement('a');
                link.href = captureURL;
                link.download = 'camera_capture_' + new Date().getTime() + '.jpg';
                link.target = '_blank';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        }

        // Update uptime display
        function updateUptime() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const uptimeString = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
            
            document.getElementById('uptime').textContent = uptimeString;
        }

        // Network change detection
        function detectNetworkChange() {
            let wasOnline = navigator.onLine;
            
            setInterval(() => {
                const isOnline = navigator.onLine;
                if (isOnline !== wasOnline) {
                    wasOnline = isOnline;
                    if (isOnline) {
                        console.log('Network reconnected, refreshing...');
                        setTimeout(refreshConnection, 2000);
                    } else {
                        console.log('Network disconnected');
                        updateCameraStatus(false);
                    }
                }
            }, 1000);
        }

        // Periodic health check
        function startHealthCheck() {
            setInterval(() => {
                if (currentCameraIP && cameraStatus) {
                    // Test if camera is still accessible
                    testCameraIP(currentCameraIP, () => {
                        // Health check completed
                    });
                }
            }, 30000); // Check every 30 seconds
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, initializing...');
            
            // Start uptime counter
            setInterval(updateUptime, 1000);
            
            // Initialize E-Ra Widget
            initializeEraWidget();
            
            // Start network change detection
            detectNetworkChange();
            
            // Start health check
            startHealthCheck();
            
            // Initial auto detection after a short delay
            setTimeout(() => {
                if (!currentCameraIP) {
                    autoDetectIP();
                }
            }, 3000);
            
            console.log('Initialization completed');
        });

        // Handle page visibility change
        document.addEventListener('visibilitychange', function() {
            if (document.visibilityState === 'visible') {
                console.log('Page became visible, refreshing stream...');
                if (streamURL && cameraStatus) {
                    setTimeout(startStream, 500);
                }
            }
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'r':
                        e.preventDefault();
                        refreshConnection();
                        break;
                    case 's':
                        e.preventDefault();
                        startStream();
                        break;
                    case 'p':
                        e.preventDefault();
                        capturePhoto();
                        break;
                }
            }
        });

        // Add error handling for global errors
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });

        // Add unhandled promise rejection handling
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

    </script>
</body>
</html>
