<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera Stream Debug & CORS Fix</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f0f2f5; padding: 20px; }
        .debug-container { max-width: 1000px; margin: 0 auto; }
        .debug-card { background: white; border-radius: 10px; padding: 20px; margin: 15px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status { padding: 10px; margin: 10px 0; border-radius: 5px; font-weight: bold; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.warning { background: #fff3cd; color: #856404; }
        .camera-container { text-align: center; margin: 20px 0; }
        .camera-stream { max-width: 100%; border: 2px solid #333; border-radius: 8px; }
        .test-section { background: #e3f2fd; padding: 15px; border-radius: 8px; margin: 15px 0; }
        .test-buttons button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .test-buttons button:hover { background: #0056b3; }
        .test-buttons .warning { background: #ffc107; color: #212529; }
        .test-buttons .danger { background: #dc3545; }
        .debug-log { background: #f8f9fa; padding: 15px; border-radius: 8px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto; border: 1px solid #dee2e6; }
        .network-info { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; }
    </style>
</head>
<body>
    <div class="debug-container">
        <div class="debug-card">
            <h1>ğŸ” Camera Stream Debug & CORS Fix</h1>
            <div id="page-info" class="status warning">Loading page information...</div>
        </div>

        <!-- Network Detection -->
        <div class="debug-card">
            <h3>ğŸŒ Network Detection</h3>
            <div class="network-info">
                <p><strong>Dashboard URL:</strong> <span id="dashboard-url">-</span></p>
                <p><strong>Protocol:</strong> <span id="page-protocol">-</span></p>
                <p><strong>Camera IP:</strong> <span id="camera-ip">192.168.1.91</span></p>
                <p><strong>Stream URL:</strong> <span id="stream-url">http://192.168.1.91/stream</span></p>
                <p><strong>Issue Detected:</strong> <span id="issue-type">Analyzing...</span></p>
            </div>
        </div>

        <!-- Test Methods -->
        <div class="debug-card">
            <h3>ğŸ§ª Test Methods</h3>
            <div class="test-section">
                <h4>Method 1: Direct Browser Test</h4>
                <p>Test if browser can access camera directly (same network)</p>
                <div class="test-buttons">
                    <button onclick="testDirectAccess()">ğŸ“¹ Open Camera Stream in New Tab</button>
                    <button onclick="testCameraPage()">ğŸ  Open Camera Homepage</button>
                </div>
            </div>

            <div class="test-section">
                <h4>Method 2: CORS Proxy Test</h4>
                <p>Use proxy to bypass CORS (if camera accessible but blocked by CORS)</p>
                <div class="test-buttons">
                    <button onclick="testCORSProxy()" class="warning">ğŸ”„ Test with CORS Proxy</button>
                    <button onclick="testBase64Stream()" class="warning">ğŸ“· Test Base64 Stream</button>
                </div>
            </div>

            <div class="test-section">
                <h4>Method 3: Alternative Display</h4>
                <p>Alternative methods if direct stream fails</p>
                <div class="test-buttons">
                    <button onclick="testIframe()">ğŸ–¼ï¸ Test iframe Embed</button>
                    <button onclick="testRefreshImage()">ğŸ”„ Test Auto-refresh Image</button>
                    <button onclick="enableInsecureContent()" class="danger">ğŸ”“ Enable Insecure Content Guide</button>
                </div>
            </div>
        </div>

        <!-- Camera Display Tests -->
        <div class="debug-card">
            <h3>ğŸ“¹ Camera Display Tests</h3>
            
            <!-- Method 1: Direct Stream -->
            <div class="test-section">
                <h4>ğŸ¯ Method 1: Direct Stream (Current)</h4>
                <div id="stream1-status" class="status warning">Testing direct stream...</div>
                <img id="stream1" class="camera-stream" 
                     src="http://192.168.1.91/stream" 
                     alt="Direct stream test"
                     onload="streamLoaded(1)" 
                     onerror="streamFailed(1, 'Direct stream failed - likely CORS or network issue')">
            </div>

            <!-- Method 2: CORS Proxy -->
            <div class="test-section">
                <h4>ğŸ”„ Method 2: CORS Proxy</h4>
                <div id="stream2-status" class="status warning">Click test button to try</div>
                <img id="stream2" class="camera-stream" style="display: none;" 
                     alt="CORS proxy test"
                     onload="streamLoaded(2)" 
                     onerror="streamFailed(2, 'CORS proxy failed')">
            </div>

            <!-- Method 3: iframe -->
            <div class="test-section">
                <h4>ğŸ–¼ï¸ Method 3: iframe Embed</h4>
                <div id="stream3-status" class="status warning">Click test button to try</div>
                <iframe id="stream3" style="display: none; width: 100%; height: 400px; border: 2px solid #333; border-radius: 8px;" 
                        onload="streamLoaded(3)" 
                        onerror="streamFailed(3, 'iframe embed failed')"></iframe>
            </div>

            <!-- Method 4: Auto-refresh Image -->
            <div class="test-section">
                <h4>ğŸ”„ Method 4: Auto-refresh Capture</h4>
                <div id="stream4-status" class="status warning">Click test button to try</div>
                <img id="stream4" class="camera-stream" style="display: none;" 
                     alt="Auto-refresh capture test"
                     onload="streamLoaded(4)" 
                     onerror="streamFailed(4, 'Auto-refresh failed')">
            </div>
        </div>

        <!-- Debug Log -->
        <div class="debug-card">
            <h3>ğŸ“ Debug Log</h3>
            <div id="debug-log" class="debug-log"></div>
        </div>
    </div>

    <script>
        let cameraIP = "192.168.1.91";
        let streamURL = `http://${cameraIP}/stream`;
        let refreshInterval;

        function logDebug(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debug-log');
            const colorClass = type === 'error' ? 'color: red;' : type === 'success' ? 'color: green;' : type === 'warning' ? 'color: orange;' : '';
            logElement.innerHTML += `<div style="${colorClass}">[${timestamp}] ${message}</div>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function updateStatus(elementId, message, type = 'warning') {
            const element = document.getElementById(elementId);
            element.className = `status ${type}`;
            element.textContent = message;
        }

        function detectNetworkIssue() {
            const protocol = window.location.protocol;
            const hostname = window.location.hostname;
            
            document.getElementById('dashboard-url').textContent = window.location.href;
            document.getElementById('page-protocol').textContent = protocol;
            document.getElementById('camera-ip').textContent = cameraIP;
            document.getElementById('stream-url').textContent = streamURL;

            let issueType = "Unknown";
            let pageInfo = "";

            if (protocol === 'https:') {
                issueType = "Mixed Content Issue - HTTPS page trying to load HTTP camera";
                pageInfo = "âš ï¸ HTTPS Dashboard â†’ HTTP Camera = Blocked by browser security";
                logDebug('ğŸš¨ Mixed Content Issue detected: HTTPS dashboard cannot load HTTP camera stream', 'error');
            } else if (hostname.includes('era') || hostname.includes('blynk')) {
                issueType = "Network Routing Issue - Remote dashboard cannot access local camera";
                pageInfo = "âš ï¸ Remote Dashboard â†’ Local IP = Network not reachable";
                logDebug('ğŸš¨ Network Routing Issue: Remote dashboard cannot access local IP', 'error');
            } else {
                issueType = "CORS Policy Issue - Browser blocking cross-origin requests";
                pageInfo = "âš ï¸ Browser CORS policy blocking camera access";
                logDebug('ğŸš¨ CORS Policy Issue detected', 'warning');
            }

            document.getElementById('issue-type').textContent = issueType;
            document.getElementById('page-info').textContent = pageInfo;
        }

        function streamLoaded(method) {
            updateStatus(`stream${method}-status`, 'âœ… Stream loaded successfully!', 'success');
            logDebug(`âœ… Method ${method} successful - Stream loaded`, 'success');
        }

        function streamFailed(method, reason) {
            updateStatus(`stream${method}-status`, `âŒ ${reason}`, 'error');
            logDebug(`âŒ Method ${method} failed: ${reason}`, 'error');
        }

        // Test Methods
        function testDirectAccess() {
            logDebug('ğŸ§ª Testing direct browser access to camera stream', 'info');
            window.open(streamURL, '_blank');
        }

        function testCameraPage() {
            logDebug('ğŸ§ª Testing camera homepage access', 'info');
            window.open(`http://${cameraIP}`, '_blank');
        }

        function testCORSProxy() {
            logDebug('ğŸ”„ Testing CORS proxy method', 'warning');
            const proxyURL = `https://cors-anywhere.herokuapp.com/${streamURL}`;
            const stream2 = document.getElementById('stream2');
            stream2.src = proxyURL;
            stream2.style.display = 'block';
            updateStatus('stream2-status', 'ğŸ”„ Testing CORS proxy...', 'warning');
        }

        function testBase64Stream() {
            logDebug('ğŸ“· Testing Base64 stream method', 'warning');
            // This would require server-side implementation
            updateStatus('stream2-status', 'ğŸ“· Base64 method requires server implementation', 'warning');
        }

        function testIframe() {
            logDebug('ğŸ–¼ï¸ Testing iframe embed method', 'warning');
            const iframe = document.getElementById('stream3');
            iframe.src = streamURL;
            iframe.style.display = 'block';
            updateStatus('stream3-status', 'ğŸ–¼ï¸ Testing iframe embed...', 'warning');
        }

        function testRefreshImage() {
            logDebug('ğŸ”„ Testing auto-refresh capture method', 'warning');
            const stream4 = document.getElementById('stream4');
            stream4.style.display = 'block';
            updateStatus('stream4-status', 'ğŸ”„ Starting auto-refresh (every 2s)...', 'warning');
            
            function refreshCapture() {
                const timestamp = new Date().getTime();
                stream4.src = `http://${cameraIP}/capture?t=${timestamp}`;
            }
            
            refreshCapture(); // First load
            refreshInterval = setInterval(refreshCapture, 2000); // Refresh every 2 seconds
        }

        function enableInsecureContent() {
            logDebug('ğŸ”“ Showing guide to enable insecure content', 'warning');
            alert(`To enable HTTP content on HTTPS page:

Chrome:
1. Click shield icon in address bar
2. Click "Load unsafe scripts"
3. Reload page

Firefox:
1. Click shield icon in address bar  
2. Click "Disable protection for now"
3. Reload page

Edge:
1. Click shield icon in address bar
2. Click "Allow insecure content"
3. Reload page`);
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            logDebug('ğŸš€ Camera Stream Debug initialized', 'success');
            detectNetworkIssue();
            
            // Test direct stream immediately
            logDebug('ğŸ§ª Testing direct stream access...', 'info');
        });

        // Clean up interval on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>
</body>
</html>
