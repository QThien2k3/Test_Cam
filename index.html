<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESP32-CAM Simple Stream</title>
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            height: calc(100vh - 40px);
            display: flex;
            flex-direction: column;
        }

        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        .header h1 {
            margin: 0;
            font-size: 1.8em;
            font-weight: 300;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.2);
            padding: 10px 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .camera-frame {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }

        .camera-iframe {
            width: 100%;
            height: 100%;
            border: none;
            border-radius: 10px;
        }

        .controls {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 15px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 20px;
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        .btn.danger {
            background: linear-gradient(45deg, #dc3545, #c82333);
        }

        .btn.info {
            background: linear-gradient(45deg, #17a2b8, #138496);
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #fff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
                height: calc(100vh - 20px);
            }
            
            .header h1 {
                font-size: 1.4em;
            }
            
            .status-bar {
                flex-direction: column;
                gap: 5px;
                text-align: center;
            }
            
            .btn {
                font-size: 0.8em;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìπ ESP32-CAM Live Stream</h1>
        </div>

        <div class="status-bar">
            <div>üü¢ <span id="statusText">Camera Online</span></div>
            <div>üì° IP: <span id="cameraIP">192.168.1.91</span></div>
            <div>‚è±Ô∏è <span id="uptime">00:00:00</span></div>
        </div>

        <div class="camera-frame">
            <iframe id="cameraIframe" 
                    class="camera-iframe"
                    src="http://192.168.1.91/" 
                    allowfullscreen>
            </iframe>
            
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <div>ƒêang t·∫£i camera...</div>
            </div>
        </div>

        <div class="controls">
            <button class="btn" onclick="refreshCamera()">üîÑ L√†m m·ªõi</button>
            <a class="btn info" href="http://192.168.1.91/stream" target="_blank">üì∫ Direct Stream</a>
            <a class="btn danger" href="http://192.168.1.91/capture" target="_blank">üì∏ Capture</a>
            <button class="btn info" onclick="openFullscreen()">üñ•Ô∏è To√†n m√†n h√¨nh</button>
        </div>
    </div>

    <!-- E-Ra Widget Integration -->
    <script src="https://www.unpkg.com/@eohjsc/era-widget@1.1.3/src/index.js"></script>
    <script>
        let eraWidget = null;
        let currentCameraIP = "192.168.1.91"; // Default IP
        let startTime = Date.now();

        // Initialize E-Ra Widget
        function initializeEraWidget() {
            try {
                eraWidget = new EraWidget();
                
                eraWidget.init({
                    onConfiguration: (configuration) => {
                        console.log('E-Ra Configuration received:', configuration);
                    },

                    onValues: (values) => {
                        console.log('E-Ra Values received:', values);
                        
                        // Find Virtual Pin values
                        Object.keys(values).forEach(key => {
                            const value = values[key].value;
                            
                            // Check if this looks like an IP address
                            if (typeof value === 'string' && value.match(/^\d+\.\d+\.\d+\.\d+$/)) {
                                updateCameraIP(value);
                            }
                            
                            // Check if this looks like a stream URL
                            if (typeof value === 'string' && value.includes('http://') && value.includes('/stream')) {
                                const ip = value.match(/http:\/\/([^\/]+)/)[1];
                                updateCameraIP(ip);
                            }
                        });
                    }
                });
                
                console.log('E-Ra Widget initialized successfully');
            } catch (error) {
                console.error('Failed to initialize E-Ra Widget:', error);
            }
        }

        // Update camera IP and reload iframe
        function updateCameraIP(newIP) {
            if (newIP && newIP !== currentCameraIP) {
                console.log('Updating camera IP from', currentCameraIP, 'to', newIP);
                currentCameraIP = newIP;
                
                document.getElementById('cameraIP').textContent = newIP;
                
                // Update iframe source
                const iframe = document.getElementById('cameraIframe');
                iframe.src = `http://${newIP}/`;
                
                // Show loading
                document.getElementById('loading').style.display = 'block';
                
                // Update control buttons
                updateControlButtons(newIP);
            }
        }

        // Update control button URLs
        function updateControlButtons(ip) {
            const streamBtn = document.querySelector('a[href*="/stream"]');
            const captureBtn = document.querySelector('a[href*="/capture"]');
            
            if (streamBtn) streamBtn.href = `http://${ip}/stream`;
            if (captureBtn) captureBtn.href = `http://${ip}/capture`;
        }

        // Refresh camera
        function refreshCamera() {
            const iframe = document.getElementById('cameraIframe');
            document.getElementById('loading').style.display = 'block';
            iframe.src = iframe.src + '?t=' + new Date().getTime();
        }

        // Open fullscreen
        function openFullscreen() {
            window.open(`http://${currentCameraIP}/`, '_blank', 'fullscreen=yes,scrollbars=no,resizable=no');
        }

        // Update uptime
        function updateUptime() {
            const elapsed = Date.now() - startTime;
            const hours = Math.floor(elapsed / 3600000);
            const minutes = Math.floor((elapsed % 3600000) / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            const uptimeString = 
                String(hours).padStart(2, '0') + ':' +
                String(minutes).padStart(2, '0') + ':' +
                String(seconds).padStart(2, '0');
            
            document.getElementById('uptime').textContent = uptimeString;
        }

        // Hide loading when iframe loads
        document.getElementById('cameraIframe').onload = function() {
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 1000);
        };

        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Initializing ESP32-CAM Simple iFrame...');
            
            // Start uptime counter
            setInterval(updateUptime, 1000);
            
            // Initialize E-Ra Widget
            initializeEraWidget();
            
            // Hide loading after initial load
            setTimeout(() => {
                document.getElementById('loading').style.display = 'none';
            }, 3000);
            
            console.log('Initialization completed');
        });

        // Auto-refresh iframe every 5 minutes to prevent timeout
        setInterval(() => {
            console.log('Auto-refreshing iframe...');
            refreshCamera();
        }, 300000); // 5 minutes
    </script>
</body>
</html>
